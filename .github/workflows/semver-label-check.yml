# PR Validation Workflow
#
# This workflow validates PRs for:
# 1. Semantic PR title format (e.g., "feat:", "fix:", "chore:", etc.)
# 2. Semver labels for correct version resolution by Release Drafter
#
# How it works:
# - Semantic PR title check ensures PR titles follow conventional commit format
# - Release Drafter's autolabeler automatically applies labels based on PR title patterns
#   (e.g., "feat:" -> enhancement -> minor, "fix:" -> bug -> patch)
# - Semver label check verifies at least one semver-related label is present
#
# Label to version mapping (configured in .github/release-drafter.yml):
# - "major" label -> major version bump (breaking changes)
# - "minor" label OR "enhancement"/"feature" -> minor version bump (new features)
# - "patch" label OR "bug"/"fix"/"bugfix" -> patch version bump (bug fixes)
# - No label -> defaults to patch (but this check encourages explicit labeling)

name: PR Validation

on:
  pull_request:
    types: [opened, edited, labeled, unlabeled, synchronize, ready_for_review]

permissions:
  pull-requests: read

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check semantic PR title
        uses: amannn/action-semantic-pull-request@v5
        if: ${{ github.event.pull_request.draft == false }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Configure which types are allowed (newline-delimited).
          # These are intentionally case-insensitive, allowing title casing or all lowercase.
          # See: https://github.com/commitizen/conventional-commit-types/blob/master/index.json
          types: |
            fix
            Fix
            feat
            Feat
            docs
            Docs
            ci
            CI
            chore
            Chore
            build
            Build
            test
            Test
            refactor
            Refactor
            perf
            Perf
            style
            Style

      - name: Check for "do not merge" in PR title
        if: ${{ github.event.pull_request.draft == false }}
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title.toLowerCase();
            if (title.includes('do not merge') || title.includes('do-not-merge')) {
              core.setFailed('PR title contains "do not merge" or "do-not-merge". Please remove this before merging.');
            }

  check-semver-label:
    name: Check for Semver Label
    runs-on: ubuntu-latest
    steps:
      - name: Check for semver-related labels
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const labelNames = labels.map(l => l.name.toLowerCase());
            console.log('PR labels:', labelNames.join(', '));

            // Direct semver labels
            const semverLabels = ['major', 'minor', 'patch'];

            // Labels that imply semver (mapped in release-drafter.yml)
            const minorImpliedLabels = ['enhancement', 'feature'];
            const patchImpliedLabels = ['bug', 'bugfix', 'fix', 'chore', 'ci', 'docs', 'refactor', 'testing', 'dependencies', 'security'];

            const hasSemverLabel = labelNames.some(l => semverLabels.includes(l));
            const hasMinorImplied = labelNames.some(l => minorImpliedLabels.includes(l));
            const hasPatchImplied = labelNames.some(l => patchImpliedLabels.includes(l));

            if (hasSemverLabel) {
              const found = labelNames.filter(l => semverLabels.includes(l));
              console.log(`Found explicit semver label(s): ${found.join(', ')}`);
              return;
            }

            if (hasMinorImplied) {
              const found = labelNames.filter(l => minorImpliedLabels.includes(l));
              console.log(`Found minor-implied label(s): ${found.join(', ')} -> will be treated as minor bump`);
              return;
            }

            if (hasPatchImplied) {
              const found = labelNames.filter(l => patchImpliedLabels.includes(l));
              console.log(`Found patch-implied label(s): ${found.join(', ')} -> will be treated as patch bump`);
              return;
            }

            // No semver-related label found
            core.setFailed(`
            No semver-related label found on this PR.

            Please add one of the following labels to indicate the version bump type:

            Explicit semver labels:
            - "major" - Breaking changes (X.0.0)
            - "minor" - New features (0.X.0)
            - "patch" - Bug fixes (0.0.X)

            Or use semantic PR titles (autolabeler will apply labels automatically):
            - "feat: ..." or "feature: ..." -> enhancement label -> minor bump
            - "fix: ..." -> bug label -> patch bump
            - "chore: ...", "ci: ...", "docs: ..." -> respective labels -> patch bump

            For breaking changes, add "!" before the colon: "feat!: ..." or add the "major" label.

            Note: If no label is applied, Release Drafter defaults to "patch" bump.
            `);
