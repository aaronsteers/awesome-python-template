name: On-Demand Fix

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "PR Number"
        type: string
        required: true
      comment-id:
        description: "Comment ID (Optional)"
        type: string
        required: false

jobs:
  pr-fix-on-demand:
    name: On-Demand PR Fix
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate as GitHub App (if available)
        id: get-app-token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.get-app-token.outputs.token || secrets.GITHUB_TOKEN }}

      - name: Checkout PR (${{ github.event.inputs.pr }})
        uses: dawidd6/action-checkout-pr@v1
        with:
          pr: ${{ github.event.inputs.pr }}

      - name: Get PR info
        id: pr-info
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.inputs.pr }})
          echo "repo=$(echo "$PR_JSON" | jq -r .head.repo.full_name)" >> $GITHUB_OUTPUT
          echo "branch=$(echo "$PR_JSON" | jq -r .head.ref)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash

      - name: Create URL to the run output
        id: vars
        run: echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      - name: Append comment with job run link
        id: first-comment-action
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.inputs.comment-id }}
          issue-number: ${{ github.event.inputs.pr }}
          body: |
            > **Auto-Fix Job Info**
            >
            > This job attempts to auto-fix any linting or formatting issues. If any fixes are made,
            > those changes will be automatically committed and pushed back to the PR.

            > PR auto-fix job started... [Check job output.][1]

            [1]: ${{ steps.vars.outputs.run-url }}

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Auto-Fix Ruff Format Issues
        run: uv run ruff format . || true

      - name: Auto-Fix Ruff Lint Issues
        run: uv run ruff check --fix . || true

      - name: Check for changes
        id: git-diff
        run: |
          git diff --quiet && echo "No changes to commit" || echo "changes=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Commit changes
        if: steps.git-diff.outputs.changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-fix lint and format issues"

      - name: Auto-Fix Ruff Lint Issues (Unsafe)
        run: uv run ruff check --fix --unsafe-fixes . || true

      - name: Check for changes (unsafe fixes)
        id: git-diff-2
        run: |
          git diff --quiet && echo "No changes to commit" || echo "changes=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Commit unsafe lint fixes
        if: steps.git-diff-2.outputs.changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-fix lint issues (unsafe)"

      - name: Push changes
        if: steps.git-diff.outputs.changes == 'true' || steps.git-diff-2.outputs.changes == 'true'
        run: |
          git remote add contributor https://github.com/${{ steps.pr-info.outputs.repo }}.git
          git push contributor HEAD:${{ steps.pr-info.outputs.branch }}

      - name: Append success comment
        uses: peter-evans/create-or-update-comment@v4
        if: steps.git-diff.outputs.changes == 'true' || steps.git-diff-2.outputs.changes == 'true'
        with:
          comment-id: ${{ steps.first-comment-action.outputs.comment-id }}
          reactions: hooray
          body: |
            > âœ… Changes applied successfully.

      - name: Append success comment (no-op)
        uses: peter-evans/create-or-update-comment@v4
        if: steps.git-diff.outputs.changes != 'true' && steps.git-diff-2.outputs.changes != 'true'
        with:
          comment-id: ${{ steps.first-comment-action.outputs.comment-id }}
          reactions: "+1"
          body: |
            > ğŸŸ¦ Job completed successfully (no changes).

      - name: Append failure comment
        uses: peter-evans/create-or-update-comment@v4
        if: failure()
        with:
          comment-id: ${{ steps.first-comment-action.outputs.comment-id }}
          reactions: confused
          body: |
            > âŒ Job failed.
