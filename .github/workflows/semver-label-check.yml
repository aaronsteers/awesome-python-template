# Semver Label Check Workflow
#
# This workflow ensures that PRs have appropriate semver labels (major, minor, or patch)
# for correct version resolution by Release Drafter.
#
# How it works:
# 1. Release Drafter's autolabeler automatically applies labels based on PR title patterns
#    (e.g., "feat:" -> enhancement -> minor, "fix:" -> bug -> patch)
# 2. This workflow checks that at least one semver label is present
# 3. If no semver label is found, the check fails with guidance on how to fix it
#
# Label to version mapping (configured in .github/release-drafter.yml):
# - "major" label -> major version bump (breaking changes)
# - "minor" label OR "enhancement"/"feature" -> minor version bump (new features)
# - "patch" label OR "bug"/"fix"/"bugfix" -> patch version bump (bug fixes)
# - No label -> defaults to patch (but this check encourages explicit labeling)

name: Semver Label Check

on:
  pull_request:
    types: [opened, labeled, unlabeled, synchronize]

jobs:
  check-semver-label:
    name: Check for Semver Label
    runs-on: ubuntu-latest
    steps:
      - name: Check for semver-related labels
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const labelNames = labels.map(l => l.name.toLowerCase());
            console.log('PR labels:', labelNames.join(', '));

            // Direct semver labels
            const semverLabels = ['major', 'minor', 'patch'];

            // Labels that imply semver (mapped in release-drafter.yml)
            const minorImpliedLabels = ['enhancement', 'feature'];
            const patchImpliedLabels = ['bug', 'bugfix', 'fix', 'chore', 'ci', 'docs', 'refactor', 'testing', 'dependencies', 'security'];

            const hasSemverLabel = labelNames.some(l => semverLabels.includes(l));
            const hasMinorImplied = labelNames.some(l => minorImpliedLabels.includes(l));
            const hasPatchImplied = labelNames.some(l => patchImpliedLabels.includes(l));

            if (hasSemverLabel) {
              const found = labelNames.filter(l => semverLabels.includes(l));
              console.log(`Found explicit semver label(s): ${found.join(', ')}`);
              return;
            }

            if (hasMinorImplied) {
              const found = labelNames.filter(l => minorImpliedLabels.includes(l));
              console.log(`Found minor-implied label(s): ${found.join(', ')} -> will be treated as minor bump`);
              return;
            }

            if (hasPatchImplied) {
              const found = labelNames.filter(l => patchImpliedLabels.includes(l));
              console.log(`Found patch-implied label(s): ${found.join(', ')} -> will be treated as patch bump`);
              return;
            }

            // No semver-related label found
            core.setFailed(`
            No semver-related label found on this PR.

            Please add one of the following labels to indicate the version bump type:

            Explicit semver labels:
            - "major" - Breaking changes (X.0.0)
            - "minor" - New features (0.X.0)
            - "patch" - Bug fixes (0.0.X)

            Or use semantic PR titles (autolabeler will apply labels automatically):
            - "feat: ..." or "feature: ..." -> enhancement label -> minor bump
            - "fix: ..." -> bug label -> patch bump
            - "chore: ...", "ci: ...", "docs: ..." -> respective labels -> patch bump

            For breaking changes, add "!" before the colon: "feat!: ..." or add the "major" label.

            Note: If no label is applied, Release Drafter defaults to "patch" bump.
            `);
